name: Nightly destroy task*

on:
  schedule:
    - cron: "59 23 * * *"   
  workflow_dispatch: {}

permissions:
  contents: read

jobs:
  discover:
    runs-on: ubuntu-latest
    outputs:
      dirs: ${{ steps.matrix.outputs.dirs }}
    steps:
      - uses: actions/checkout@v4

      - name: Build matrix from task* directories
        id: matrix
        run: |
          TASKS=$(find . -maxdepth 1 -type d -name "task*" -printf '%P\n' | sort)
          if [ -z "$TASKS" ]; then
            echo 'dirs=[]' >> $GITHUB_OUTPUT
            exit 0
          fi
          JSON=$(printf '%s\n' "$TASKS" | jq -R . | jq -s -c .)
          {
            echo 'dirs<<EOF'
            echo "$JSON"
            echo 'EOF'
          } >> $GITHUB_OUTPUT

  destroy:
    needs: discover
    if: ${{ needs.discover.outputs.dirs != '[]' }}
    runs-on: ubuntu-latest
    env:
      ARM_CLIENT_ID: ${{ secrets.ARM_CLIENT_ID }}
      ARM_CLIENT_SECRET: ${{ secrets.ARM_CLIENT_SECRET }}
      ARM_TENANT_ID: ${{ secrets.ARM_TENANT_ID }}
      ARM_SUBSCRIPTION_ID: ${{ secrets.ARM_SUBSCRIPTION_ID }}
      TF_VAR_student_id: ${{ github.actor }}
    strategy:
      fail-fast: false
      matrix:
        dir: ${{ fromJson(needs.discover.outputs.dirs) }}
    steps:
      - uses: actions/checkout@v4

      - name: Azure auth sanity check
        run: |
          echo "ARM_TENANT_ID=$ARM_TENANT_ID"
          echo "ARM_SUBSCRIPTION_ID=$ARM_SUBSCRIPTION_ID"
          az account show || true

      - name: Set timezone
        run: echo "TZ=Europe/Warsaw" >> $GITHUB_ENV

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.6

      - name: Terraform destroy
        working-directory: ${{ matrix.dir }}
        run: |
          terraform init -input=false
          terraform destroy -auto-approve -input=false